{% extends "base.html" %}

{% block head %}
{% endblock %}

{% block page %}
    <div class="row">
        <div class="col-lg-12">

            <h1>
                {# name #}
                {% for ingredient in medicine.ingredients -%}
                    {% if loop.index > 1 %} + {% endif %}
                    {{ ingredient.inn }}
                {%- endfor %},
                {# strength #}
                {% for ingredient in medicine.ingredients -%}
                    {% if loop.index > 1 %} + {% endif %}
                    {{ ingredient.strength }}
                {%- endfor %}
                {# dosage form #}
                {% if medicine.dosageform -%}
                    <small> ({{ medicine.dosageform }})</small>
                {%- endif %}
            </h1>

            <ul class="nav nav-tabs">
                <li class="active"><a href="#purchases" data-toggle="tab">Purchases</a></li>
                <li><a href="#products" data-toggle="tab">Products</a></li>
            </ul>

            <div class="tab-content">

                <div class="tab-pane active" id="purchases">
                    {% if medicine.procurements | length == 0 %}
                        <p style="padding: 100px;" class="lead text-muted text-center">No recent purchases recorded</p>
                    {% else %}
                        <h2>{{ medicine.procurements | length }} Purchases</h2>
                        <table class="table table-bordered table-striped">
                            <thead>
                            <th>Country</th>
                            <th>Price (USD)</th>
                            <th>Pack price (USD)</th>
                            <th>Manufacturer</th>
                            <th>MSH ratio</th>
                            <th>Incoterm</th>
                            <th>Pack size</th>
                            <th>Volume (Packs)</th>
                            <th>Procurement period</th>
                            </thead>
                            <tbody>
                            {% for procurement in medicine.procurements %}
                                <tr class="procurement-entry clickable" data-procurement-id="{{ procurement.id }}">
                                    <td>
                                        {{ macros.render_country(procurement.country) }}
                                    </td>
                                    <td>
                                        {{ procurement.price_per_unit | round(3) }}
                                    </td>
                                    <td>
                                        {{ procurement.price_usd | round(3) }}
                                    </td>
                                    <td>
                                        {{ procurement.manufacturer.name }}
                                        (
                                        {%- for tmp in procurement.manufacturer.country -%}
                                            {{ tmp }}
                                            {%- if loop.index > 1 -%}, {% endif -%}
                                        {%- endfor -%}
                                        )
                                    </td>
                                    <td>
                                        {% if procurement.price_usd and medicine.mshprice %}
                                            {{ (procurement.price_usd / medicine.mshprice) | round(1) }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ macros.render_incoterm(procurement.incoterm) }}
                                    </td>
                                    <td>
                                        {{ macros.render_pack_size(procurement.container, procurement.packsize) }}
                                    </td>
                                    <td>
                                        {{ procurement.volume }}
                                    </td>
                                    <td>
                                        {{ macros.render_date_range(procurement.start_date, procurement.end_date) }}
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>

                        <div style="width:100%;height:{{ 80 + graph_data | length * 35 }}px;text-align:center;margin:10px">
                            <div id="flot-placeholder" style="width:100%;height:100%;"></div>
                        </div>

                    {% endif %}
                </div>


                <div class="tab-pane" id="products">
                    <h2>{{ medicine.products | length }} Related Products</h2>

                    <table class="table table-bordered table-striped">
                        <thead>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Supplier(s)</th>
                        <th>Manufacturer(s)</th>
                        <th>Procurement country</th>
                        </thead>
                        <tbody>
                        {% for product in medicine.products %}
                            <tr class="product-entry clickable" data-product-id="{{ product.id }}">
                                <td>
                                    {{ macros.render_product(product, medicine.ingredients) }}
                                </td>
                                <td>
                                    {% if product.generic %}
                                        Generic
                                    {% else %}
                                        Proprietary
                                    {% endif %}
                                </td>
                                <td>
                                    {% for procurement in product.procurements -%}
                                        {% if procurement.supplier -%}
                                            {%- if loop.index > 1 -%}, {% endif -%}
                                            {{ procurement.supplier.name }}
                                        {%- else -%}
                                            N/A
                                        {%- endif -%}
                                    {% endfor %}
                                </td>
                                <td>
                                    {% for procurement in product.procurements -%}
                                        {%- if loop.index > 1 -%}, {% endif -%}
                                        {{ procurement.manufacturer.name }}
                                    {% endfor %}
                                </td>
                                <td>
                                    {% for procurement in product.procurements -%}
                                        {% if procurement.country -%}
                                            {%- if loop.index > 1 -%}, {% endif -%}
                                            {{ macros.render_country(procurement.country) }}
                                        {%- endif -%}
                                    {% endfor %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
{% endblock %}

{% block javascript %}
    <!--[if lte IE 8]><script language="javascript" type="text/javascript" src="/js/flot/excanvas.min.js"></script><![endif]-->

    <script type="text/javascript" src="/static/flot/jquery.flot.min.js"></script>
    <script type="text/javascript" src="/static/flot/jquery.flot.axislabels.js"></script>
    <script type="text/javascript" src="/static/flot/jshashtable-2.1.js"></script>
    <script type="text/javascript" src="/static/flot/jquery.numberformatter-1.2.3.min.js"></script>

    <script>
        $(document).ready(function(){
            $(".procurement-entry").on('click', function(e){
                var procurement_id = $(this).attr('data-procurement-id').toString()
                window.location = "/procurement/" + procurement_id
            })
            $(".product-entry").on('click', function(e){
                var product_id = $(this).attr('data-product-id').toString()
                window.location = "/product/" + product_id
            })
        });
    </script>

    <script type="text/javascript">
        // HORIZONTAL BAR CHART, based on example from http://www.jqueryflottutorial.com/how-to-make-jquery-flot-horizontal-bar-chart.html
        var rawData = {{ graph_data }};
        var dataSet = [{ label: "Purchases", data: rawData, color: "#547CC1" }];
        var ticks = {{ labels | safe }};

        var markings = [
            { color: "#FF4444", lineWidth: 2, xaxis: { from: {{ medicine.mshprice }}, to: {{ medicine.mshprice }} } }
        ];

        var options = {
            series: {
                bars: {
                    show: true
                }
            },
            bars: {
                align: "center",
                barWidth: 0.5,
                horizontal: true,
                fillColor: { colors: [{ opacity: 0.9 }, { opacity: 1}] },
                lineWidth: 1
            },
            xaxes: [
                {
                    position: "bottom",
                    axisLabel: "Unit price (USD)",
                    axisLabelUseCanvas: true,
                    axisLabelFontSizePixels: 12,
                    axisLabelFontFamily: 'Verdana, Arial',
                    axisLabelPadding: 10,
                    max: {{ max_price }},
                    tickColor: "#5E5E5E",
                    color: "black"
                },
                {
                    position: "top",
                    ticks: [[{{ medicine.mshprice }}, "MSH price ({{ medicine.mshprice | round(3)}})"]],
                    max: {{ max_price }}
                }
            ],
            yaxis: {
                axisLabel: "Country",
                axisLabelUseCanvas: true,
                axisLabelFontSizePixels: 12,
                axisLabelFontFamily: 'Verdana, Arial',
                axisLabelPadding: 3,
                tickColor: "#5E5E5E",
                ticks: ticks,
                color: "black"
            },
            legend: {
                show: false
            },
            grid: {
                hoverable: true,
                borderWidth: 1,
                backgroundColor: { colors: ["#fefefe", "#dddddd"] },
                markings: markings
            }
        };
        {% if medicine.procurements | length > 0 %}
            $(document).ready(function () {
                $.plot($("#flot-placeholder"), [{ label: "Purchases", data: rawData, color: "#547CC1" }, { data: [[]], xaxis: 2}], options);
                $("#flot-placeholder").UseTooltip();
            });
        {% endif %}

        var previousPoint = null, previousLabel = null;

        $.fn.UseTooltip = function () {
            $(this).bind("plothover", function (event, pos, item) {
                if (item) {
                    if ((previousLabel != item.series.label) ||
                            (previousPoint != item.dataIndex)) {
                        previousPoint = item.dataIndex;
                        previousLabel = item.series.label;
                        $("#tooltip").remove();

                        var x = item.datapoint[0];
                        var y = item.datapoint[1];

                        var color = item.series.color;

                        showTooltip(item.pageX,
                                item.pageY,
                                color,
                                "<strong>" + item.series.label + "</strong><br>" + item.series.yaxis.ticks[y].label +
                                        " : <strong>" + Math.round(x*1000)/1000 + "</strong> USD");
                    }
                } else {
                    $("#tooltip").remove();
                    previousPoint = null;
                }
            });
        };

        function showTooltip(x, y, color, contents) {
            $('<div id="tooltip">' + contents + '</div>').css({
                position: 'absolute',
                display: 'none',
                top: y - 10,
                left: x + 10,
                border: '2px solid ' + color,
                padding: '3px',
                'font-size': '9px',
                'border-radius': '5px',
                'background-color': '#fff',
                'font-family': 'Verdana, Arial, Helvetica, Tahoma, sans-serif',
                opacity: 0.9
            }).appendTo("body").fadeIn(200);
        }
    </script>
{% endblock %}