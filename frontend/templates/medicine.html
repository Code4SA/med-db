{% extends "base.html" %}

{% block page_header %}
    <div class="container">
        <h1>
            {% if medicine.name %}
                {{ medicine.name }}
            {% endif %}
            <nobr>
                <small class="text-muted">
                    {{ medicine.dosage_form.name }}
                </small>
            </nobr>
        </h1>
    </div>
{% endblock %}

{% block page %}

    <div class="row">
        <div class="col-lg-12">
            {% if medicine.benchmarks %}
                {% for benchmark in medicine.benchmarks %}
                    <div class="alert alert-success">
                        This medicine's {{ benchmark.name }} benchmark price for {{ benchmark.year }} is ${{ benchmark.price }}.
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>

    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="tablist">
        <li class="active"><a href="#procurements" role="tab" data-toggle="tab">Procurements</a></li>
        <li><a href="#comparison" role="tab" data-toggle="tab">Manufacturer Comparison</a></li>
        <li><a href="#cost-calculator" role="tab" data-toggle="tab">Cost Calculator</a></li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">

    <div class="tab-pane active" id="procurements">
        <div class="row">
            <div class="col-lg-12">
                {% if medicine.procurements | length == 0 %}
                    <p style="padding: 10px;" class="lead text-muted">No recent purchases recorded</p>
                {% else %}
                    <p></p>
                    <table class="table table-bordered table-striped table-hover">
                        <thead>
                        <th>Procurement country</th>
                        <th>Generic Name</th>
                        <th>Description/Brand</th>
                        <th>Date</th>
                        <th>Terms</th>
                        <th>Volume</th>
                        <th>Price</th>
                        </thead>
                        <tbody>
                        {% for procurement in medicine.procurements %}
                            {% set width = (100 * (1 - (max_price - procurement.unit_price_usd) / max_price)) | int%}
                            <tr class="procurement-entry clickable" data-procurement-id="{{ procurement.procurement_id }}">
                                <td>
                                    {{ macros.render_flag(procurement.country) }} {{ procurement.country.name }}
                                </td>
                                <td>
                                    {% if procurement.product.medicine %}
                                        {{ procurement.product.medicine.name }}
                                    {% else %}
                                        <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if procurement.product.description %}
                                        {{ procurement.product.description }}
                                    {% else %}
                                        <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ macros.render_date_range(procurement.start_date, procurement.end_date) }}
                                </td>
                                <td>
                                    {% if procurement.incoterm %}
                                        {{ procurement.incoterm.code }} ({{ procurement.incoterm.description }})
                                    {% endif %}
                                </td>
                                <td>
                                    {{ procurement.quantity | add_commas }} <br>({{ procurement.pack_size }} {{ procurement.product.medicine.unit_of_measure }} {{ procurement.container }}s)
                                </td>
                                <td class="price-bar-container">
                                            <span class="pull-right">
                                    ${{ procurement.unit_price_usd }}
                                    </span>
                                    <div class="price-bar" style="width: {{ width }}%;"></div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="tab-pane" id="comparison">
        <div class="row">
            <div class="col-lg-12">
                <h2>Products</h2>

                {% if medicine.products %}
                    <table class="table table-bordered table-striped">
                        <thead>
                        <th>Generic Name (Strength)</th>
                        <th>Description/Brand</th>
                        <th>Manufacturer</th>
                        <th>Generic/Originator</th>
                        <th>Average price (USD)</th>
                        </thead>
                        <tbody>

                        {% for product in medicine.products %}
                            {% set width = (100 * (1 - (max_avg_price - product.average_price) / max_avg_price)) | int%}
                            <tr>
                                <td>
                                    <strong>
                                            <span
                                                    class="tooltip-enabled"
                                                    data-toggle="tooltip"
                                                    data-placement="right"
                                                    title="Maximum shelf life: {% if product.shelf_life %}{{ product.shelf_life }}{% else %}unknown{% endif %}">
                                                {{ medicine.name }}
                                            </span>
                                    </strong>
                                </td>
                            <td>
                                    <strong>
                                           {% if product.description %}{{ product.description }}{% endif %}
                                    </strong>
                                </td>
                                <td>
                                    {% if product.manufacturer %}
                                        {%- if product.manufacturer.country -%}
                                            {{ macros.render_flag(product.manufacturer.country) }}
                                        {% endif -%}
                                        <a class="manufacturer modal-link" onclick="show_manufacturer_modal({{ product.manufacturer.manufacturer_id }})"><strong>
                                            {{ product.manufacturer.name }}
                                            {%- if product.manufacturer.country -%}
                                                , {{ product.manufacturer.country.name }}
                                            {%- endif -%}
                                        </strong>
                                        </a>
                                    {% else %}
                                        <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if product.is_generic %}Generic{% else %}Originator{% endif %}
                                </td>
                                <td class="price-bar-container">
                                    {% if product.average_price %}
                                        <span class="pull-right">
                                    ${{ product.average_price }}
                                    </span>
                                        <div class="price-bar" style="width: {{ width }}%;"></div>

                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>We don't know of any products for this medicine.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="tab-pane" id="cost-calculator">
        <div class="row">
            <div class="col-lg-12">
                <h2>Least expensive procurements</h2>

                <form id="form-comparison" class="form form-inline" method="get" action="">
                    <div class="form-group">
                        <p><em>Calculate cost difference:</em></p>
                    </div>
                    <div class="form-group">
                        <label class="sr-only" for="compare-quantity">Quantity</label>
                        <input name="compare-quantity" class="form-control" type="text" placeholder="Quantity" {% if form_args['compare-quantity'] %}value="{{ form_args['compare-quantity'] }}"{% endif %}/>
                    </div>
                    <div class="form-group">
                        <label class="sr-only" for="compare-price">Price</label>
                        <input name="compare-price" class="form-control" type="text" placeholder="Unit price (USD)" {% if form_args['compare-price'] %}value="{{ form_args['compare-price'] }}"{% endif %}/>
                    </div>
                    <button class="btn btn-default" type="submit">Calculate</button>
                </form>
                {% if medicine.procurements | length == 0 %}
                    <p style="padding: 10px;" class="lead text-muted">No recent purchases recorded</p>
                {% else %}
                    <p></p>
                    <table class="table table-bordered table-striped">
                        <thead>
                        <th>Procurement country</th>
                        <th>Generic Name (Strength)</th>
                        <th>Description/Brand</th>
                        <th>Date</th>
                        <th>Terms</th>
                        <th>Volume</th>
                        <th>Price</th>
                        <th>Cost difference</th>
                        </thead>
                        <tbody>
                        {% for procurement in best_procurements %}
                            <tr class="procurement-entry clickable" data-procurement-id="{{ procurement.procurement_id }}">
                                <td>
                                    {{ macros.render_flag(procurement.country) }} {{ procurement.country.name }}
                                </td>
                                <td>
                                    {% if procurement.product.medicine %}
                                        {{ procurement.product.medicine.name }}
                                    {% else %}
                                        <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if procurement.product.description %}
                                        {{ procurement.product.description }}
                                    {% else %}
                                        <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                {{ macros.render_date_range(procurement.start_date, procurement.end_date) }}
                                </td>
                                <td>
                                    {% if procurement.incoterm %}
                                        {{ procurement.incoterm.code }} ({{ procurement.incoterm.description }})
                                    {% endif %}
                                </td>
                                <td>
                                    {{ procurement.quantity | add_commas }} ({{ procurement.pack_size }} {{ procurement.unit_of_measure }} {{ procurement.container }}s)
                                </td>
                                <td>
                                    ${{ procurement.unit_price_usd }}
                                </td>
                                <td>
                            <span>
                                {% if procurement.cost_difference %}
                                    {% if procurement.cost_difference < 0 %}- {% endif %}
                                    ${{ procurement.cost_difference | abs }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </span>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% endif %}
            </div>
        </div>
    </div>
    </div>


{% endblock %}

{% block javascript %}
    {{ super() }}
    <script>
        $(document).ready(function(){
            $(".procurement-entry").on('click', function(){
                tmp = this
                var procurement_id = $(this).attr('data-procurement-id');
                window.location = '/procurement/' + procurement_id + '/';
            })
        });
    </script>
{% endblock %}