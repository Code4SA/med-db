(function(){meddb={},meddb.template={},meddb.template.cache={},meddb.template.load=function(e,t,n){n=n||"#meddb_inner_container";var r=function(e){d3.select(n)[0][0].innerHTML="",d3.select(n)[0][0].appendChild(e)};meddb.template.cache[e]&&(r(meddb.template.cache[e]),t()),d3.html(e,function(n){meddb.template.cache[e]=n,r(n),t()})},meddb.router=function(){var e=location.hash,t=meddb.history.list[meddb.history.list.length-1];if(t&&e==t.hash)return;if(e==""||e=="#")location.hash="medicine";else if(e.substring(0,5)=="#tab:"){var n=e.substring(5);meddb.tabber.change(n)}else{var r="";if(e=="#medicine")meddb.medicine.list();else if(e.substring(0,10)=="#medicine:"){var i=parseInt(e.substring(10));meddb.medicine.detail(i)}else if(e.substring(0,9)=="#product:"){var i=parseInt(e.substring(9));meddb.product.detail(i)}else if(e.substring(0,10)=="#supplier:"){var i=parseInt(e.substring(10));meddb.supplier.detail(i)}else if(e.substring(0,5)=="#tab:"){var n=e.substring(5);d3.select("div#meddb_inner_container").select("div.tab-content").selectAll("div.tab-pane").classed("active",!1),d3.select("div#meddb_inner_container").select("div.tab-content").select("div.tab-pane#"+n).classed("active",!0)}}},meddb.history={},meddb.history.list=[],meddb.history.add=function(e,t){var n=meddb.history.list[meddb.history.list.length-1];if(n&&e==n.hash)return;meddb.history.list.push({hash:e,text:t}),d3.select("ul#meddb_breadcrumb").selectAll("li").remove();var r=d3.select("ul#meddb_breadcrumb").selectAll("li").data(meddb.history.list.slice(-5)).enter().append("li");r.append("a").attr("href",function(e){return e.hash}).text(function(e){return e.text}),r.append("span").classed("divider",!0).text(" / ")},meddb.tabber={},meddb.tabber.init=function(){var e=function(){return meddb.tabber.change(this.href.split("#tab:")[1]),!1};d3.selectAll('a[href^="#tab:"]').on("click",e)},meddb.tabber.onclick=function(e){return meddb.tabber.change(e.href.split("#tab:")[1]),e.parentNode.className+=" active",!1},meddb.tabber.change=function(e){d3.select("div#meddb_inner_container").select("div.tab-content").selectAll("div.tab-pane").classed("active",!1),d3.select("div#meddb_inner_container").select("div.tab-content").select("div.tab-pane#"+e).classed("active",!0),d3.select("div#meddb_inner_container").select("ul.nav.nav-tabs").selectAll("li").classed("active",!1),d3.select("div#meddb_inner_container").select("ul.nav.nav-tabs").select('li>a[href="#tab:'+e+'"]').classed("active",!0)},meddb.medicine={},meddb.medicine.list=function(){var e=function(e){var t=[],n=[],r=[];return e.ingredients.forEach(function(e){n.push(e.inn),r.push(e.strength)}),t.push(n.join(" + ")),t.push(r.join(" + ")),t.push(e.dosageform.name),t.push(d3.round(e.avgprice,4)),t},t=function(e,t){return e&&t?e.ingredients[0].inn<t.ingredients[0].inn?-1:e.ingredients[0].inn>t.ingredients[0].inn?1:0:0};meddb.template.load("medicine_list.html",function(){d3.json("/json/medicine/",function(t){var n=d3.select("#meddb_container").select("#meddb_medicine_list").select("tbody").selectAll("tr").data(t).enter().append("tr").style("cursor","pointer").on("click",function(e){location.hash="medicine:"+e.id});n.selectAll("td").data(e).enter().append("td").text(function(e){return e})})}),meddb.history.add(location.hash,"All Medicine")},meddb.medicine.detail=function(e){meddb.template.load("medicine_detail.html",function(){d3.json("/json/medicine/"+e+"/",function(e){var t=function(){var t=[];return e.ingredients.forEach(function(e){t.push(e.inn+" "+e.strength)}),t.join(" + ")},n=function(e){var t=[];return t.push(e.country.name),t.push(d3.round(e.price,4)),t.push(e.validity),t};d3.select("#meddb_medicine_heading").text(t());var r=d3.select("#meddb_container").select("#meddb_medicine_procurement").select("tbody").selectAll("tr").data(e.procurements).enter().append("tr");r.selectAll("td").data(n).enter().append("td").text(function(e){return e});var i=function(e){var t=[];return t.push({text:e.product.name,hash:"product:"+e.product.id}),e.supplier?t.push({text:e.supplier.name,hash:"supplier:"+e.supplier.id}):t.push({text:""}),e.manufacturer?t.push({text:e.manufacturer.name,hash:"manufacturer:"+e.manufacturer.id}):t.push({text:""}),t.push({text:e.country.name}),t};d3.select("#meddb_medicine_heading").text(t());var r=d3.select("#meddb_container").select("#meddb_medicine_product").select("tbody").selectAll("tr").data(e.procurements).enter().append("tr");r.selectAll("td").data(i).enter().append("td").text(function(e){return e.text}).style("cursor",function(e){if(e.hash)return"pointer"}).on("click",function(e){e.hash&&(location.hash=e.hash)});var s=function(){var t=["Kenya","Uganda","Tanzania"],n={};return e.procurements.forEach(function(e){typeof n[e.country.name]=="undefined"&&(n[e.country.name]=[]),n[e.country.name].push(e.price)}),u=[],t.forEach(function(e){var t={key:e};n[e]&&n[e].length>0?t.value=d3.sum(n[e])/n[e].length:t.value=0,u.push(t)}),u},o=function(e){var t=0,n=0;return e.forEach(function(e){e.value>0&&(t+=e.value,n++)}),t/n},u=s(),a=o(u),f={width:940,height:95,node:"#meddb_medicine_prices",bar:{height:25,margin:10,max:a*2,background:"#dfe7e5"},colors:["#08c","#08c","#08c","#08c","#08c","#08c","#08c","#08c"],line:{constant:d3.round(a,4)},data:u};d3.select("#meddb_medicine_prices").html("");var l=new HorizontalBarGraph(f);meddb.history.add(location.hash,t())})})},meddb.product={},meddb.product.detail=function(e){meddb.template.load("product_detail.html",function(){d3.json("/json/product/"+e+"/",function(e){var t=function(){var t=[],n=[],r=[];return e.medicine.ingredients.forEach(function(e){n.push(e.inn),r.push(e.strength)}),t.push(n.join(" + ")),t.push(r.join(" + ")),t},n=function(e){var t=[];return t.push({text:e.country.name}),e.supplier?t.push({text:e.supplier.name,hash:"supplier:"+e.supplier.id}):t.push({text:""}),e.manufacturer?t.push({text:e.manufacturer.name,hash:"manufacturer:"+e.manufacturer.id}):t.push({text:""}),t};d3.select("#meddb_product_heading").text(e.name),d3.select("table#meddb_product_detail").selectAll("td").data(t).text(function(e){return e});var r=d3.select("table#meddb_product_registration").select("tbody").selectAll("tr").data(e.procurements).enter().append("tr");r.selectAll("td").data(n).enter().append("td").text(function(e){return e.text}).style("cursor",function(e){if(e.hash)return"pointer"}).on("click",function(e){location.hash=e.hash}),meddb.history.add(location.hash,e.name)})})},meddb.supplier={},meddb.supplier.detail=function(e){meddb.template.load("supplier_detail.html",function(){d3.json("/json/supplier/"+e+"/",function(e){var t=function(e){var t=[];t.push({text:e.product.name,hash:"product:"+e.product.id}),t.push({text:e.country.name});var n=[];return e.product.medicine.ingredients.forEach(function(e){n.push(e.inn+" "+e.strength)}),t.push({text:n.join(", "),hash:"medicine:"+e.product.medicine.id}),t};d3.select("#meddb_supplier_heading").text(e.name);var n=d3.select("table#meddb_supplier_registration").select("tbody").selectAll("tr").data(e.procurements).enter().append("tr");n.selectAll("td").data(t).enter().append("td").text(function(e){return e.text}).style("cursor",function(e){if(e.hash)return"pointer"}).on("click",function(e){location.hash=e.hash}),meddb.history.add(location.hash,e.name)})})},meddb.template.load("base.html",function(){meddb.router()},"#meddb_container"),window.onhashchange=meddb.router})();