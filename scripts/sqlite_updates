drop table ingredient;
drop table component;

-- alter medicine table
BEGIN TRANSACTION;
CREATE TEMPORARY TABLE medicine_backup(medicine_id, name, unit_of_measure_id, dosage_form_id);
INSERT INTO medicine_backup SELECT medicine_id, name, unit_of_measure_id, dosage_form_id FROM medicine;
DROP TABLE medicine;
CREATE TABLE medicine (
	medicine_id INTEGER NOT NULL,
	name VARCHAR(100) NOT NULL,
	unit_of_measure_id INTEGER NOT NULL,
	dosage_form_id INTEGER NOT NULL,
	PRIMARY KEY (medicine_id),
	CONSTRAINT medicine_name_dosage_form UNIQUE (name, dosage_form_id),
	FOREIGN KEY(unit_of_measure_id) REFERENCES unit_of_measure (unit_of_measure_id),
	FOREIGN KEY(dosage_form_id) REFERENCES dosage_form (dosage_form_id)
);
INSERT INTO medicine SELECT medicine_id, name, unit_of_measure_id, dosage_form_id FROM medicine_backup;
DROP TABLE medicine_backup;
COMMIT;

-- alter procurement table
BEGIN TRANSACTION;
CREATE TEMPORARY TABLE procurement_backup(procurement_id, container, pack_size, pack_price, pack_price_usd, unit_price_usd, quantity, method, start_date, end_date, added_on, approved, currency_id, product_id, incoterm_id, country_id, supplier_id, source_id, added_by_id, approved_by_id);
INSERT INTO procurement_backup SELECT procurement_id, container, pack_size, pack_price, pack_price_usd, unit_price_usd, quantity, method, start_date, end_date, added_on, approved, currency_id, product_id, incoterm_id, country_id, supplier_id, source_id, added_by_id, approved_by_id FROM procurement;
DROP TABLE procurement;
CREATE TABLE procurement (
	procurement_id INTEGER NOT NULL,
	container VARCHAR(50),
	pack_size INTEGER,
	pack_price FLOAT,
	pack_price_usd FLOAT NOT NULL,
	unit_price_usd FLOAT,
	quantity INTEGER NOT NULL,
	method VARCHAR(100),
	start_date DATE NOT NULL,
	end_date DATE,
	added_on DATE,
	approved BOOLEAN,
	currency_id INTEGER NOT NULL,
	product_id INTEGER NOT NULL,
	incoterm_id INTEGER,
	country_id INTEGER,
	supplier_id INTEGER,
	source_id INTEGER,
	added_by_id INTEGER,
	approved_by_id INTEGER,
	PRIMARY KEY (procurement_id),
	CHECK (approved IN (0, 1)),
	FOREIGN KEY(currency_id) REFERENCES currency (currency_id),
	FOREIGN KEY(product_id) REFERENCES product (product_id),
	FOREIGN KEY(incoterm_id) REFERENCES incoterm (incoterm_id),
	FOREIGN KEY(country_id) REFERENCES country (country_id),
	FOREIGN KEY(supplier_id) REFERENCES supplier (supplier_id),
	FOREIGN KEY(source_id) REFERENCES source (source_id),
	FOREIGN KEY(added_by_id) REFERENCES user (user_id),
	FOREIGN KEY(approved_by_id) REFERENCES user (user_id)
);
INSERT INTO procurement SELECT procurement_id, container, pack_size, pack_price, pack_price_usd, unit_price_usd, quantity, method, start_date, end_date, added_on, approved, currency_id, product_id, incoterm_id, country_id, supplier_id, source_id, added_by_id, approved_by_id FROM procurement_backup;
DROP TABLE procurement_backup;
COMMIT;
